#!/usr/bin/env bash
set -eu

export JOBS_COMMON_DIR='/var/vcap/packages/mongodb-jobs-common'
source ${JOBS_COMMON_DIR}/bin/setenv mongod
source ${JOBS_COMMON_DIR}/bin/mdb-functions

if [ $(check_ssl) -eq 0 ]
then
  export MONGO_CMD="${JOBS_COMMON_DIR}/bin/mongo.sh"
else
  # Generate the certificates
  ${JOBS_COMMON_DIR}/bin/generate_ssl_cert.sh
  export MONGO_CMD="${JOBS_COMMON_DIR}/bin/mongo-ssl.sh"
fi

export MONGO_CMD_PARAM="--quiet"

# In standalone mode node is simply removed
# otherwise
if [ "$(get_node_role)" != "sa" ]
then
	# monit must not restart the process
	# toogle it to not monitored
	monit unmonitor mongodb_server
    rs_scaleDown # remove the node from replicaset   
fi

# then kill mongod preocess
kill_and_wait ${PIDFILE}

exit 0