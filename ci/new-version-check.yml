---
resource_types:
  - name: keyval
    type: docker-image
    source:
      repository: swce/keyval-resource

  - name: mongo-src
    type: docker-image
    source:
      repository: jraverdyorange/concourse-mongodb-resource        

resources:

  - name: mongodb-bosh-release
    type: git
    source:
      uri:    ((repositories.mongodb.uri))
      branch: ((repositories.mongodb.branch))

  - name: mongodb-version
    type: semver
    source: &semver-source
      initial_version:  1.0.0
      driver:           git
      uri:              https://github.com/orange-cloudfoundry/mongodb-boshrelease.git
      branch:           master
      file:             mongodb_version
      username:         ((repositories.mongodb.username))
      password:         ((repositories.mongodb.password))
      git_user:         "((repositories.mongodb.git_user)) <((repositories.mongodb.email))>"
    
  - name: mongodb-new-version
    type: mongo-src
    source:
      branch: "3.6"

jobs:

# clone current "main" blobstore to dev one
- name: clone-blobstore
  serial: true
  plan:
    - get: mongodb-bosh-release

    - get: mongodb-new-version
      trigger: true    

    - task: blobstore-cleanup
      file: mongodb-bosh-release/ci/tasks/clone-blobstore/blobstore-cleanup.yml
      params:
        ACCESS_KEY_ID:      ((blobstores.release.access_key_id))
        SECRET_ACCESS_KEY:  ((blobstores.release.secret_access_key))
        ENDPOINT_URL:       ((blobstores.release.endpoint-url))
        BUCKET:             ((blobstores.release.bucket))
        SKIP_SSL:           ((blobstores.release.skip-ssl-validation))
        SSL_CERT:           ((blobstores.release.certificate))


    - task: create-bosh-config
      file: mongodb-bosh-release/ci/tasks/create-bosh-config.yml
      params:
        CA_CERT:  ((bosh-server.ca))
        IP:       ((bosh-server.ip))
        ALIAS:    ((bosh-server.alias)) 
        USER:     ((bosh-server.user))
        PASSWORD: ((bosh-server.password))

    - task: get-release-blobs
      file: mongodb-bosh-release/ci/tasks/clone-blobstore/get-release-blobs.yml
      params:
        ALIAS:              ((bosh-server.alias))
        ACCESS_KEY_ID:      ((blobstores.release.access_key_id))
        SECRET_ACCESS_KEY:  ((blobstores.release.secret_access_key))
        ENDPOINT_URL:       ((blobstores.release.endpoint-url))
        BUCKET:             ((blobstores.release.bucket))     
        SIGNATURE_VERSION:  ((blobstores.release.signature-version))
        GOLANG_VERSION:     ((deployment.golang-version))

    - task: blobs-rename
      file: mongodb-bosh-release/ci/tasks/clone-blobstore/blobs-rename.yml
      params:
        ACCESS_KEY_ID:      ((blobstores.release.access_key_id))
        SECRET_ACCESS_KEY:  ((blobstores.release.secret_access_key))
        ENDPOINT_URL:       ((blobstores.release.endpoint-url))
        BUCKET:             ((blobstores.release.bucket))
        SIGNATURE_VERSION:  ((blobstores.release.signature-version))  

- name: prepare-blobstore
  plan:

    - get: mongodb-bosh-release

    - get: mongodb-new-version
      passed: [clone-blobstore]
      trigger: true          

    - aggregate:

      - get: mongodb-version

      - &create-bosh-config
        do:
          - task: create-bosh-config
            file: mongodb-bosh-release/ci/tasks/create-bosh-config.yml
            params:
              CA_CERT:  ((bosh-server.ca))
              IP:       ((bosh-server.ip))
              ALIAS:    ((bosh-server.alias)) 
              USER:     ((bosh-server.user))
              PASSWORD: ((bosh-server.password))

    - &get-config-files
      task: get-config-files
      file: mongodb-bosh-release/ci/tasks/get-config-files.yml
      params: &get-config-files-params
        CURRENT: true # fetch current main release config
        CONFIG_PATH:        ((blobstores.release.config_path))
        ACCESS_KEY_ID:      ((blobstores.release.access_key_id))
        SECRET_ACCESS_KEY:  ((blobstores.release.secret_access_key))
        ENDPOINT_URL:       ((blobstores.release.endpoint-url))
        BUCKET:             ((blobstores.release.bucket))
        SIGNATURE_VERSION:  ((blobstores.release.signature-version))
        SKIP_SSL:           ((blobstores.release.skip-ssl-validation))
        SSL_CERT:           ((blobstores.release.certificate))
        GOLANG_VERSION:     ((deployment.golang-version))

    - &upload-new-blobs
      task: upload-new-blobs
      file: mongodb-bosh-release/ci/tasks/upload-new-blobs.yml
      params:
        ACCESS_KEY_ID:            ((blobstores.release.access_key_id))
        SECRET_ACCESS_KEY:        ((blobstores.release.secret_access_key))
        ENDPOINT_URL:             ((blobstores.release.endpoint-url))
        BUCKET:                   ((blobstores.release.bucket))
        SIGNATURE_VERSION:        ((blobstores.release.signature-version))
        SKIP_SSL:                 ((blobstores.release.skip-ssl-validation))
        SSL_CERT:                 ((blobstores.release.certificate))

    - &upload-config-files
      task: upload-config-files
      file: mongodb-bosh-release/ci/tasks/upload-config-files.yml
      params: &upload-config-files-params
        ACCESS_KEY_ID:      ((blobstores.release.access_key_id))
        SECRET_ACCESS_KEY:  ((blobstores.release.secret_access_key))
        ENDPOINT_URL:       ((blobstores.release.endpoint-url))
        BUCKET:             ((blobstores.release.bucket))
        SKIP_SSL:           ((blobstores.release.skip-ssl-validation))
        SSL_CERT:           ((blobstores.release.certificate))
        CONFIG_PATH:        ((blobstores.release.config_path))
        